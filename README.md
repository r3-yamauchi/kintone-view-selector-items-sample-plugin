# kintone 一覧表示制御プラグイン

[![Ask DeepWiki](https://deepwiki.com/badge.svg)](https://deepwiki.com/r3-yamauchi/kintone-view-selector-items-sample-plugin)

kintoneのレコード一覧画面で、一覧選択メニューに表示する一覧を制御できるプラグインです。
プラグイン設定画面で各一覧の表示/非表示を設定することで、ユーザーが不要な一覧を非表示にすることができます。

## 主な機能

- プラグイン設定画面で一覧の一覧を自動取得
- 各一覧の表示/非表示をチェックボックスで簡単に設定
- **NEW!** グループ所属に基づいた条件付き非表示設定
  - 2つの条件タイプから選択可能：
    - **指定したグループのいずれかに所属する場合は非表示**: 特定グループのユーザーに対して非表示
    - **指定したグループのいずれにも所属しない場合は非表示**: 特定グループに所属していないユーザーに対して非表示（特定グループのみに表示）
  - 複数のグループコードを指定可能
- デスクトップ版・モバイル版の両方に対応
- 設定に基づいてレコード一覧画面の一覧選択メニューを制御

## 使用方法

### 1. プラグインのインストール

```bash
# 秘密鍵の生成（初回のみ）
npm run keygen

# プラグインのビルド
npm run build
```

ビルドされた `dist/plugin.zip` をkintoneアプリにインストールします。

### 2. プラグイン設定

1. 対象アプリのプラグイン設定画面を開きます
2. インストールしたプラグインの設定を開きます
3. 一覧の一覧が自動的に表示されます
4. 非表示にしたい一覧のチェックを外します（常に非表示にする場合）
5. **条件付き非表示を設定する場合**：
   - 一覧の右側にある「条件」ボタンをクリック
   - 「条件付き非表示を有効にする」にチェック
   - 条件タイプを選択：
     - **指定したグループのいずれかに所属する場合は非表示**: 選択したグループに所属するユーザーに対して非表示
     - **指定したグループのいずれにも所属しない場合は非表示**: 選択したグループに所属していないユーザーに対して非表示
   - グループ選択欄をクリックして、対象のグループを選択（複数選択可能）
   - 例1：条件タイプ「いずれかに所属する場合は非表示」、グループ選択で「営業部」「マーケティング部」を選択 → 営業部またはマーケティング部グループに所属するユーザーには非表示
   - 例2：条件タイプ「いずれにも所属しない場合は非表示」、グループ選択で「管理者」を選択 → 管理者グループに所属していないユーザーには非表示（管理者のみ表示）
6. 「保存」ボタンをクリックして設定を保存します

### 3. レコード一覧画面での動作確認

設定保存後、レコード一覧画面を開くと：
- チェックを外した一覧が常に非表示になります
- 条件付き非表示を設定した一覧は、選択した条件タイプとグループ所属に基づいて動的に非表示が制御されます
  - 条件タイプ「いずれかに所属する場合は非表示」: 指定したグループに所属しているユーザーには非表示
  - 条件タイプ「いずれにも所属しない場合は非表示」: 指定したグループに所属していないユーザーには非表示
- デスクトップ版・モバイル版の両方で動作します

## 対応画面

- デスクトップ版レコード一覧画面（`app.record.index.show`）
- モバイル版レコード一覧画面（`mobile.app.record.index.show`）

## 使用している API とライブラリ

### kintone JavaScript API
- [kintone.app.showViewSelectorItems()](https://cybozu.dev/ja/kintone/docs/js-api/record/show-or-hide-view-selector-items/) - デスクトップ版での一覧表示制御
- [kintone.mobile.app.showViewSelectorItems()](https://cybozu.dev/ja/kintone/docs/js-api/record/show-or-hide-view-selector-items/) - モバイル版での一覧表示制御
- [kintone.getLoginUser()](https://cybozu.dev/ja/kintone/docs/js-api/common/get-login-user/) - ログインユーザー情報の取得

### 外部ライブラリ
- [kintone UI Component](https://ui-component.kintone.dev/ja/) v1.24.0
  - UserOrgGroupSelectコンポーネントを使用してグループ選択UIを実装
  - `src/js/kuc.min.js` としてプラグインに同梱

## ビルド・開発

```bash
# 依存パッケージのインストール
npm install

# 秘密鍵の生成（初回のみ）
npm run keygen

# プラグインのビルド
npm run build

# 開発モード（ファイル監視）
npm run develop

# プラグインのアップロード（要設定）
npm run upload
```

## 技術仕様

### 設定データ形式

プラグイン設定には、各一覧の表示設定が保存されます：

```json
{
  "viewSettings": "[
    {
      \"viewId\": \"12345\",
      \"alwaysHidden\": false,
      \"conditionalHidden\": {
        \"enabled\": true,
        \"matchType\": \"includes\",
        \"groupCodes\": [\"sales\", \"marketing\"]
      }
    },
    {
      \"viewId\": \"67890\",
      \"alwaysHidden\": false,
      \"conditionalHidden\": {
        \"enabled\": true,
        \"matchType\": \"notIncludes\",
        \"groupCodes\": [\"admin\"]
      }
    },
    {
      \"viewId\": \"99999\",
      \"alwaysHidden\": true,
      \"conditionalHidden\": {
        \"enabled\": false,
        \"matchType\": \"includes\",
        \"groupCodes\": []
      }
    }
  ]"
}
```

#### 設定項目の説明

- `viewId`: 一覧ID
- `alwaysHidden`: 常に非表示にするか（チェックボックスを外した場合は `true`）
- `conditionalHidden`: 条件付き非表示の設定
  - `enabled`: 条件付き非表示を有効にするか
  - `matchType`: 条件タイプ（`includes` または `notIncludes`）
    - `includes`: 指定したグループのいずれかに所属する場合は非表示
    - `notIncludes`: 指定したグループのいずれにも所属しない場合は非表示
  - `groupCodes`: グループコードの配列

#### 旧形式からの移行

旧形式（`hiddenViewIds`）の設定は自動的に新形式に変換されます。旧形式で非表示に設定されていた一覧は、新形式では `alwaysHidden: true` として扱われます。

### 特殊な一覧ID

- 一覧ID `20`: 「（すべて）」を表す特殊な一覧として自動追加されます

## 利用シーン

このプラグインは以下のような場面で活用できます：

- **一覧の整理**: 使用頻度の低い一覧を非表示にして、画面をすっきりさせる
- **部門・グループ別の一覧制御**: グループに基づいて、関係のない一覧を自動的に非表示
  - 例：営業グループ（sales）には「開発中の案件」一覧を非表示、開発グループ（development）には「営業活動」一覧を非表示
  - 条件タイプ：「いずれかに所属する場合は非表示」、グループコード：`sales`
- **権限・役職による制御**: 特定のグループに基づいて一覧を制御
  - 例：管理者グループ（admin）以外には「管理者用一覧」を非表示
  - 条件タイプ：「いずれにも所属しない場合は非表示」、グループコード：`admin`
- **特定グループのみに表示**: 条件タイプ「いずれにも所属しない場合は非表示」を使用
  - 例：承認者グループ（approver）のみに「承認待ち案件」一覧を表示
  - 条件タイプ：「いずれにも所属しない場合は非表示」、グループコード：`approver`
- **テスト環境**: 開発中やテスト中の一覧を本番環境で非表示にする
- **ユーザビリティ向上**: 必要な一覧だけを表示してユーザーの選択肢を減らす

## 注意事項

- このプラグインは、一覧選択メニューでの一覧の表示/非表示のみを制御します
- 一覧そのものを削除したり、アクセス権限を変更したりするものではありません
- 設定画面では `/k/v1/preview/app/views.json` APIを使用するため、プレビュー環境の一覧情報を取得します
- グループ選択には kintone UI Component v1.24.0 を使用しています（プラグインに同梱）
- グループ一覧の取得には `/v1/groups.json` APIを使用するため、ユーザーに適切な権限が必要です

## ライセンス

本プラグインは AGPL-3.0 ライセンスです。

**「kintone」はサイボウズ株式会社の登録商標です。**

ここに記載している内容は情報提供を目的としており、個別のサポートはできません。
設定内容についてのご質問やご自身の環境で動作しないといったお問い合わせをいただいても対応はできませんので、ご了承ください。
